# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Flask-based web application that performs **Principal Component Analysis (PCA)** on European Central Bank (ECB) yield curve data to generate stress scenarios for risk management. The application fetches Euro area AAA-rated government bond spot rates, analyzes them using PCA, and generates 99.5% quantile-based stress scenarios compliant with Solvency II regulations.

## Application Architecture

### Three-Layer Service Architecture

The application follows a clean service-oriented architecture:

1. **Data Layer** (`services/ecb_api.py`): Fetches yield curve data from ECB Statistical Data Warehouse REST API for 32 maturities (3M to 30Y)
2. **Analysis Layer** (`services/pca_analysis.py`): Performs PCA using scikit-learn, generates visualizations with Plotly
3. **Stress Testing Layer** (`services/stress_scenarios.py`): Calculates rolling quantiles and generates stress scenarios by perturbing principal components

### Key Workflow

The main analysis flow in `app.py`:
1. User submits date range via `/api/analyze` endpoint
2. `ECBDataService.fetch_yield_curve()` retrieves data from ECB (or demo data in demo mode)
3. `PCAAnalyzer.perform_pca()` extracts principal components (typically PC1=Level ~95%, PC2=Slope ~4%, PC3=Curvature ~1%)
4. `StressScenarioGenerator.generate_scenarios()` computes rolling 99.5% quantiles on 30-day differences with 24-month windows
5. Stress scenarios are generated by applying quantile shocks to each PC and reconstructing yield curves
6. Results are cached via Flask-Caching and returned as Plotly JSON for frontend visualization

## Development Commands

### Local Development

```bash
# Setup virtual environment
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# or: venv\Scripts\activate  # Windows

# Install dependencies
pip install -r requirements.txt

# Run development server
python app.py
# App runs on http://localhost:5000
```

### Testing

```bash
# Run all tests
pytest

# Run specific test suites
pytest tests/unit/                    # Unit tests only
pytest tests/integration/             # Integration tests only

# Run with verbose output
pytest -v

# Run specific test file
pytest tests/unit/test_pca_analysis.py

# Run with coverage
pytest --cov=services --cov=app
```

Test structure:
- `tests/unit/`: Unit tests for individual services (ecb_api, pca_analysis, stress_scenarios)
- `tests/integration/`: End-to-end API tests
- `tests/conftest.py`: Shared fixtures including demo data

### Code Quality

```bash
# Format code (if black is installed)
black app.py services/

# Lint code (if flake8 is installed)
flake8 app.py services/
```

## Configuration

All configuration is centralized in `config.py` and loaded from environment variables:

### Key Configuration Parameters

- `DEMO_MODE`: Set to `true` to use demo data instead of live ECB API (useful for testing without network)
- `N_COMPONENTS`: Number of principal components (default: 5)
- `STRESS_QUANTILE`: Stress quantile level (default: 0.995 = 99.5%)
- `ROLLING_WINDOW_MONTHS`: Rolling window for quantile calculation (default: 24 months)
- `CACHE_TIMEOUT`: Cache duration in seconds (default: 3600)
- `ENABLE_EXPORT`: Enable CSV/Excel export endpoints (default: true)

Environment variables override defaults. Example:
```bash
export DEMO_MODE=true
export STRESS_QUANTILE=0.99
python app.py
```

## Deployment

### Netcup Webhosting (Phusion Passenger)

The application is designed for deployment on Netcup Webhosting 4000/8000 with Phusion Passenger:

1. **Entry Point**: `passenger_wsgi.py` (required filename for Passenger)
2. **App Root**: Place all files in `pca-app/` directory outside of `html/`
3. **Dependencies**: Pre-install dependencies locally and upload as `vendor/` directory (Netcup webhosting has no SSH/CLI)
4. **Restart**: Touch `tmp/restart.txt` to reload the application after code changes

Full deployment instructions are in `DEPLOYMENT.md`.

### Local Testing with Gunicorn

```bash
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

## Important Implementation Details

### PCA Score Calculation

The PCA workflow (`services/pca_analysis.py`):
- Centers data by subtracting mean curve before PCA
- Factor loadings (components) are stored in `pca.components_`
- Scores are calculated via `pca.transform(centered_data)`
- Reconstruction uses: `scores @ components + mean_curve`

### Stress Scenario Generation

The stress methodology (`services/stress_scenarios.py`):
- Calculates 30-day rolling differences of PC scores (approximates monthly changes)
- Separates positive and negative movements
- Computes rolling 99.5% quantile over 24-month windows
- Applies quantile shock to one PC at a time, keeping others constant
- Reconstructs yield curves using only first 4 PCs (matches R reference implementation)

### Caching Strategy

Results are cached via `@cache.memoize()` decorator on `_perform_analysis_cached()`:
- Cache key includes: start_date, end_date, n_components, stress_quantile, rolling_window
- Default timeout: 1 hour (3600 seconds)
- Cache can be cleared via `/api/cache/clear` POST endpoint

### ECB API Data Structure

ECB Data Portal API (`https://data-api.ecb.europa.eu`) returns SDMX-JSON format with complex nested structure:
- Series are indexed by dimension combinations
- Maturity dimension is `DATA_TYPE_FM`
- Time dimension is in `structure.dimensions.observation`
- Parser (`_parse_ecb_response`) pivots data to wide format with Date column + 32 maturity columns
- Note: The old SDW endpoint (`sdw-wsrest.ecb.europa.eu`) is deprecated; use the new Data Portal API

### Demo Mode

When `DEMO_MODE=true`:
- Loads data from `demo_data/sample_yield_curve.csv` instead of ECB API
- Useful for development without network access or when ECB API is unavailable
- Demo data should be in same format as ECB output (Date + SR_3M to SR_30Y columns)

## API Endpoints

- `GET /` - Main UI page
- `POST /api/analyze` - Main analysis endpoint (accepts start_date, end_date, optional advanced params)
- `GET /api/health` - Health check endpoint
- `POST /api/cache/clear` - Clear application cache
- `POST /api/export/csv` - Export yield curve data as CSV
- `POST /api/export/excel` - Export full analysis as Excel with multiple sheets

## Common Development Patterns

### Adding a New Visualization

1. Create plot generation method in appropriate service (e.g., `_create_new_plot()`)
2. Return Plotly figure as JSON: `return fig.to_json()`
3. Add plot to results dictionary in service method
4. Frontend receives plot JSON and renders with `Plotly.newPlot()`

### Modifying PCA Parameters

To add new configurable parameters:
1. Add to `Config` class in `config.py` with environment variable support
2. Accept parameter in `/api/analyze` endpoint with validation
3. Pass parameter to `PCAAnalyzer` or `StressScenarioGenerator` constructor
4. Update `_perform_analysis_cached()` to include parameter in cache key

### Working with ECB API Changes

If ECB API structure changes:
1. Update `_parse_ecb_response()` in `services/ecb_api.py`
2. Test with live data and demo data
3. Update demo data format if needed (`demo_data/sample_yield_curve.csv`)
4. Update tests in `tests/unit/test_ecb_api.py`

## Troubleshooting

### Import Errors in Tests

Tests use `conftest.py` fixtures. If imports fail:
- Ensure you're running pytest from repository root: `pytest` (not `python -m pytest`)
- Check that `__init__.py` exists in `tests/`, `tests/unit/`, `tests/integration/`

### ECB API Timeout or No Data

- ECB API can be slow (2-5 seconds typical)
- Set `DEMO_MODE=true` to bypass ECB API during development
- Check timeout setting: `ECB_API_TIMEOUT` (default 30 seconds)
- ECB data availability: spot rates may not be available for very recent dates (1-2 day lag)

### PCA Errors with Insufficient Data

- PCA requires sufficient observations (at least 30 days recommended)
- Validate date range in endpoint before analysis
- Handle missing values: ECB data may have gaps for certain maturities/dates

### Passenger Deployment Issues

- Ensure `passenger_wsgi.py` is present and exports `application` variable
- Check Python version compatibility (requires Python 3.9+)
- Verify all dependencies are in `vendor/` directory with correct paths in `sys.path`
- Enable "Development" mode in Netcup WCP to see detailed error messages
